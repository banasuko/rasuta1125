import streamlit as st
from PIL import Image
from openai import OpenAI
import io

# OpenAIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–ï¼ˆ.streamlit/secrets.toml ã§è¨­å®šæ¸ˆã¿ã‚’æƒ³å®šï¼‰
client = OpenAI(api_key=st.secrets["OPENAI_API_KEY"])

st.title("ğŸ“¸ ãƒãƒŠãƒ¼ç”»åƒã‹ã‚‰ã‚³ãƒ”ãƒ¼æ¡ˆã‚’ç”Ÿæˆ")

# 1. ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
uploaded_image = st.file_uploader("ãƒãƒŠãƒ¼ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰", type=["jpg", "png"])
if uploaded_image:
    image = Image.open(uploaded_image)
    st.image(image, caption="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒ", use_column_width=True)

# 2. ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠ
category = st.selectbox("ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠ", [
    "ç¾å®¹å®¤", "è„±æ¯›ã‚µãƒ­ãƒ³", "ã‚¨ã‚¹ãƒ†", "ãƒã‚¤ãƒ«ãƒ»ã¾ã¤ã’", "ãƒ›ãƒ¯ã‚¤ãƒˆãƒ‹ãƒ³ã‚°",
    "æ•´ä½“ãƒ»æ¥éª¨é™¢", "å­¦ç¿’å¡¾", "å­ã©ã‚‚å†™çœŸé¤¨", "é£²é£Ÿåº—", "ãã®ä»–"
])

# 3. è£œè¶³æƒ…å ±å…¥åŠ›
target = st.text_input("ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå±¤ï¼ˆä¾‹ï¼š30ä»£å¥³æ€§ã€çµŒå–¶è€…ãªã©ï¼‰")
feature = st.text_area("å•†å“ã®ç‰¹å¾´ãƒ»ã‚¢ãƒ”ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆ")
tone = st.selectbox("ãƒˆãƒ¼ãƒ³ï¼ˆé›°å›²æ°—ï¼‰ã‚’é¸æŠ", ["è¦ªã—ã¿ã‚„ã™ã„", "é«˜ç´šæ„Ÿ", "æƒ…ç†±çš„", "ãŠã‚‚ã—ã‚ç³»", "çœŸé¢ç›®"])

# 4. ã‚³ãƒ”ãƒ¼ç”Ÿæˆæ•°
copy_count = st.selectbox("ã‚³ãƒ”ãƒ¼ç”Ÿæˆæ•°ã‚’é¸ã‚“ã§ãã ã•ã„", [2, 5, 10], index=1)

# 5. ç”Ÿæˆãƒœã‚¿ãƒ³
if st.button("ã‚³ãƒ”ãƒ¼ã‚’ç”Ÿæˆã™ã‚‹"):

    with st.spinner("ã‚³ãƒ”ãƒ¼æ¡ˆã‚’ç”Ÿæˆä¸­..."):

        # è–¬æ©Ÿæ³•ãƒã‚§ãƒƒã‚¯ãŒå¿…è¦ãªã‚«ãƒ†ã‚´ãƒª
        needs_yakkihou = category in ["è„±æ¯›ã‚µãƒ­ãƒ³", "ã‚¨ã‚¹ãƒ†", "ãƒ›ãƒ¯ã‚¤ãƒˆãƒ‹ãƒ³ã‚°"]

        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹æˆ
        system_prompt = "ã‚ãªãŸã¯å„ªç§€ãªåºƒå‘Šã‚³ãƒ”ãƒ¼ãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚"
        user_prompt = f"""
ä»¥ä¸‹ã®æƒ…å ±ã‚’ã‚‚ã¨ã«ã€ãƒãƒŠãƒ¼åºƒå‘Šã«ä½¿ãˆã‚‹ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ã‚’{copy_count}æ¡ˆææ¡ˆã—ã¦ãã ã•ã„ã€‚
ã€æ¥­ç¨®ã€‘{category}
ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå±¤ã€‘{target}
ã€ç‰¹å¾´ãƒ»ã‚¢ãƒ”ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆã€‘{feature}
ã€ãƒˆãƒ¼ãƒ³ã€‘{tone}
- å„ã‚³ãƒ”ãƒ¼ã¯30æ–‡å­—ä»¥å†…ã«åã‚ã¦ãã ã•ã„ã€‚
- åŒã˜æ–¹å‘æ€§ã®ã‚³ãƒ”ãƒ¼ã¯é¿ã‘ã€ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æŒãŸã›ã¦ãã ã•ã„ã€‚
{ 'ãƒ»è–¬æ©Ÿæ³•ã«é…æ…®ã—ã€ã€Œæ²»ã‚‹ã€ã€Œå³åŠ¹ã€ã€Œæ°¸ä¹…ã€ã€ŒåŒ»ç™‚è¡Œç‚ºçš„è¡¨ç¾ã€ãªã©ã¯é¿ã‘ã¦ãã ã•ã„ã€‚' if needs_yakkihou else '' }
"""

        try:
            response = client.chat.completions.create(
                model="gpt-4",
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_prompt}
                ]
            )

            output = response.choices[0].message.content.strip()

            st.subheader("âœï¸ ã‚³ãƒ”ãƒ¼æ¡ˆ")
            st.markdown(output)

            if needs_yakkihou:
                st.subheader("ğŸ” è–¬æ©Ÿæ³•ãƒã‚§ãƒƒã‚¯")
                st.info("â€» ã“ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§ã¯è–¬æ©Ÿæ³•ã«é…æ…®ã—ãŸè¡¨ç¾ã«ãªã£ã¦ã„ã‚‹ã‹æ³¨æ„ã—ã¦ãã ã•ã„ã€‚\nNGãƒ¯ãƒ¼ãƒ‰ä¾‹ï¼šã€Œå³åŠ¹ã€ã€Œæ²»ã‚‹ã€ã€Œæ°¸ä¹…ã€ãªã©")

        except Exception as e:
            st.error(f"ã‚³ãƒ”ãƒ¼ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š{e}")
